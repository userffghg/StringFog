```markdown

# StringFog

StringFog is an Android Gradle plugin that automatically encrypts strings inside dex/aar/jar files. As the name suggests, it wraps strings in a layer of "fog" to make them harder to inspect.

- Supports Java and Kotlin.
- Works on strings in app APKs produced by the build process.
- Can encrypt strings in library files such as AAR and JAR.
- Supports custom encryption/decryption algorithm implementations.
- Optional configuration to control which code is encrypted.
- Fully integrated with Gradle automation.
- Does not support Instant Run.

**A note about maintenance**
> My main focus is currently on the [Reqable](https://reqable.com) startup, so Issue responses for StringFog may be slower than before — sorry about that!
Although I no longer work on Android full-time, I will try to maintain StringFog as much as possible. If you find issues that can be fixed, please feel free to submit a PR.

### How it works

![](https://github.com/MegatronKing/StringFog/blob/master/assets/flow.png)<br>

- Before encryption:
```java
String a = "This is a string!";
```

- After encryption:
```java
String a = StringFog.decrypt(new byte[]{-113, 71...}, new byte[]{-23, 53});

```

- At runtime:
```java
decrypt: new byte[]{-113, 71...} => "This is a string!"
```

### ProGuard / R8
StringFog does not conflict with code obfuscation tools — no special keep rules are required. In fact, combining StringFog with code obfuscation often improves protection.

### Usage
Because StringFog is provided as a Gradle plugin, integration is straightforward and won't disturb normal build configurations. The plugin is published to Maven Central — just add the plugin and the runtime implementation dependency.

Note: `jcenter` has been deprecated and publishing to `jcenter` was removed since v3.0+

#### 1) Add the plugin dependency in the root `build.gradle`:
```groovy
buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        ...
        classpath 'com.github.megatronking.stringfog:gradle-plugin:5.2.0'
        // The encryption implementation library. XOR is provided by default, or use your own.
        classpath 'com.github.megatronking.stringfog:xor:5.0.0'
    }
}
```

#### 2) Configure the plugin in your `app` or `library` module `build.gradle`:
```groovy
apply plugin: 'stringfog'

// Import key generator class. If you use HardCodeKeyGenerator, change the class accordingly.
import com.github.megatronking.stringfog.plugin.kg.RandomKeyGenerator
import com.github.megatronking.stringfog.plugin.StringFogMode

stringfog {
    // Required: the implementation class of the encryption library, must match the dependency above.
    implementation 'com.github.megatronking.stringfog.xor.StringFogImpl'
    // Optional: StringFog tries to obtain the packageName automatically; specify explicitly if needed.
    packageName 'com.github.megatronking.stringfog.app'
    // Optional: enable/disable encryption (enabled by default).
    enable true
    // Optional: specify packages to encrypt (can list multiple). If omitted, all packages will be processed.
    fogPackages = ['com.xxx.xxx']
    // Optional (added in v3.0): key generator. Default uses a random 8-byte key (different per string).
    // You can also use a fixed key: HardCodeKeyGenerator("This is a key")
    kg new RandomKeyGenerator()
    // Optional (added in v4.0): control how encrypted data appears in bytecode; default is base64.
    // Also supports text or bytes.
    mode StringFogMode.base64
}
```

KTS example:
```kotlin
plugins {
    // ... library or application
    id("stringfog")
}
apply(plugin = "stringfog")

configure<StringFogExtension> {
    // Required: encryption implementation class, must match the dependency used below.
    implementation = "com.github.megatronking.stringfog.xor.StringFogImpl"
    // Optional: enable/disable encryption (default: true).
    enable = true
    // Optional: specify packages to encrypt.
    // fogPackages = arrayOf("com.xxx.xxx")
    kg = com.github.megatronking.stringfog.plugin.kg.RandomKeyGenerator()
    // base64 or bytes
    mode = com.github.megatronking.stringfog.plugin.StringFogMode.bytes
}
```

#### 3) Add the runtime encryption implementation dependency in your module `build.gradle`:

```groovy
dependencies {
      ...
      // This must match the encryption implementation chosen above; it's used at runtime to decrypt strings.
      compile 'com.github.megatronking.stringfog:xor:5.0.0'
}
```

#### Important
Starting with AGP 8.0, BuildConfig is not generated by default, but StringFog relies on it. Make sure to enable it:
```kotlin
android {
    // Please add this configuration
    buildFeatures {
        buildConfig = true
    }
    ...
}
```

### Extensions

#### Annotation to skip encryption
If you have classes that should not be automatically encrypted, use the `@StringFogIgnore` annotation:
```java
@StringFogIgnore
public class Test {
    ...
}
```

#### Custom encryption implementation
Implement the `IStringFog` interface — see the `stringfog-ext` modules for the XOR example.
Note that some algorithms may behave differently across platforms, which can cause runtime decryption failures. Example:
```java
public final class StringFogImpl implements IStringFog {

    @Override
    public byte[] encrypt(String data, byte[] key) {
        // custom encryption
    }

    @Override
    public String decrypt(byte[] data, byte[] key) {
        // custom decryption
    }

    @Override
    public boolean shouldFog(String data) {
        // control whether a string should be encrypted
        // Recommend filtering out unimportant or very long strings
        return true;
    }

}
```

#### Custom key generator
Implement the `IKeyGenerator` interface — see `RandomKeyGenerator` for reference.

#### Mapping file
**Note ⚠️: Mapping generation has issues in StringFog v5.x and is temporarily disabled.**
When enabled, a mapping file that links plaintext to ciphertext is generated at `outputs/mapping/stringfog.txt`.

## Samples
- Default encryption implementation: [StringFog-Sample1](https://github.com/MegatronKing/StringFog-Sample1)
- Custom encryption implementation: [StringFog-Sample2](https://github.com/MegatronKing/StringFog-Sample2)

## Changelog

### v5.2.0
- Upgraded ASM from v7 to v9.
- Fixed multi-module configuration issues.

### v5.1.0
- Fixed issue obtaining packageName in some cases.
- Fixed specifying a custom KeyGenerator.
- Improved task logic for generating `StringFog.java`.
- Temporarily removed mapping file generation due to deletion issues.

### v5.0.0
- Added support for Gradle 8.0.

### v4.0.1
- Fixed Base64 API compatibility issue.

### v4.0.0
- Updated to ASM7 to support Android 12.
- Added support for AGP 7.x.
- Added `StringFogMode` DSL option to control how encrypted data appears in bytecode — supports `base64` and `bytes` (default `base64`).
  - `base64` mode: encrypted bytes are Base64-encoded in bytecode (same behavior as v1.x and v2.x).
  - `bytes` mode: encrypted bytes are directly embedded in bytecode (same behavior as v3.x).

### v3.0.0
- Ciphertext is no longer stored as a `String`, but as a raw byte array (thanks to PR #50).
- Public API refactor (breaking changes).
- Removed AES implementation due to bugs and performance concerns.
- XOR algorithm no longer uses Base64 encoding.
- Per-string random keys replaced fixed key; `IKeyGenerator` added for custom implementations.
- Plugin ASM dependency upgraded to 9.2.

### v2.2.1
- Fixed crash caused by `module-info` classes.

### v2.2.0
- Added support for AGP 3.3.0+.

### v2.1.0
- Fixed Kotlin packaging bug.

### v2.0.1
- Improved error messages for custom `implementation` algorithm classes.

### v2.0.0
- Modified Gradle configuration (now requires `implementation` to specify algorithm implementation).
- Fixed compilation failures for large strings.
- Added custom encryption extension support.
- Added generation of mapping file.

### v1.4.1
- Fixed `ZipException` compilation error when using Java 8.

### v1.4.0
- Added `fogPackages` option to specify packages to encrypt.
- Removed `exclude` option.

### v1.3.0
- Fixed Gradle 3.0+ compile error.

### v1.2.2
- Fixed packaging bug on Windows.

### v1.2.1
- Fixed file separator bug on Windows.
- Fixed compile issue when `applicationId` and `packageName` differ.
- Improved behavior so libraries already processed by StringFog need not be manually excluded.

### v1.2.0
- Support for use inside libraries; each library can use a different key.
- Support `exclude` to skip specified packages.
- Fixed several known bugs.

--------

    Copyright (C) 2016-2023, Megatron King

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

```
